<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CakeHistory</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="{% if request.endpoint in ['login_user_route', 'register'] %}auth-page{% endif %}">
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CakeHistory Logo" class="logo-img">
            <h1>CakeHistory</h1>
        </div>

        <nav class="nav-links">
            <a href="{{ url_for('home') }}"><i class="fa-solid fa-house"></i> Home</a>
            <a href="{{ url_for('menu') }}"><i class="fa-solid fa-utensils"></i> Menu</a>
            <a href="{{ url_for('cart') }}"><i class="fa-solid fa-cart-shopping"></i> Cart</a>
            <a href="{{ url_for('order') }}"><i class="fa-solid fa-box"></i> Order</a>
            <a href="{{ url_for('feedback') }}"><i class="fa-solid fa-pen-to-square"></i> Feedback</a>
        </nav>

        <div class="auth-buttons">
            {% if current_user.is_authenticated %}
                <span>Hi, {{ current_user.name }}</span>
                <a href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            {% else %}
                <a href="{{ url_for('login_user_route') }}"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
                <a href="{{ url_for('register') }}"><i class="fa-solid fa-user-plus"></i> Register</a>
            {% endif %}
        </div>
    </header>

    <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>Â© 2025 CakeHistory. All rights reserved.</p>
    </footer>

    <!-- Floating Chat Button -->
    <div id="chat-btn" class="chat-btn">
    <i class="fa-solid fa-comments"></i>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="chat-modal">
    <div class="chat-modal-content">
        <span class="close-chat">&times;</span>
        <h3><i class="fa-solid fa-message"></i> Chat with CakeHistory</h3>
        <p>Select a topic to get started:</p>
        
        <div class="chat-options">
        <button class="chat-option" data-topic="Order Status">ğŸ° Order Status</button>
        <button class="chat-option" data-topic="Custom Cake">ğŸ‚ Custom Cake Inquiry</button>
        <button class="chat-option" data-topic="Store Info">ğŸª Store Information</button>
        </div>

        <textarea id="chat-input" placeholder="Type your message..." rows="3"></textarea>
        <button id="send-chat" class="send-chat-btn">Send</button>

        <div id="chat-response" class="chat-response"></div>
    </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cartLink = document.querySelector('a[href="{{ url_for("cart") }}"]');
            const isAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}" === "true";

            if (!isAuthenticated && cartLink) {
                cartLink.addEventListener('click', e => {
                    e.preventDefault(); // stop direct navigation
                    Swal.fire({
                        icon: 'info',
                        title: 'Login Required',
                        text: 'Please login to view your cart or place an order.',
                        confirmButtonText: 'Login',
                        confirmButtonColor: '#ff69b4',
                        showCancelButton: true,
                        cancelButtonText: 'Cancel',
                        cancelButtonColor: '#999',
                        scrollbarPadding: false
                    }).then(result => {
                        if (result.isConfirmed) {
                            window.location.href = "{{ url_for('login_user_route') }}";
                        }
                    });
                });
            }

            const chatBtn = document.getElementById('chat-btn');
            const chatModal = document.getElementById('chat-modal');
            const closeChat = document.querySelector('.close-chat');
            const chatOptions = document.querySelectorAll('.chat-option');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-chat');
            const chatResponse = document.getElementById('chat-response');

            // Show modal
            chatBtn.addEventListener('click', () => {
                chatModal.style.display = 'flex';
            });

            // Close modal
            closeChat.addEventListener('click', () => chatModal.style.display = 'none');
            chatModal.addEventListener('click', e => {
                if (e.target === chatModal) chatModal.style.display = 'none';
            });

            // When user clicks a preset topic
            chatOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                chatInput.value = `Hi, Iâ€™d like to ask about ${opt.dataset.topic}.`;
                });
            });

            // Send message (mock AI reply)
            sendBtn.addEventListener('click', () => {
                const msg = chatInput.value.trim();
                if (!msg) return;
                
                chatResponse.innerHTML = `<p><strong>You:</strong> ${msg}</p>`;
                setTimeout(() => {
                chatResponse.innerHTML += `<p><strong>CakeHistory Bot:</strong> Thanks for reaching out! Weâ€™ll get back to you soon ğŸ°</p>`;
                }, 1000);
                chatInput.value = '';
            });
        });
    </script>
</body>
</html>
