<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CakeHistory</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="{% if request.endpoint in ['login_user_route', 'register'] %}auth-page{% endif %}">
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CakeHistory Logo" class="logo-img">
            <h1>CakeHistory</h1>
        </div>

        <nav class="nav-links">
            <a href="{{ url_for('home') }}"><i class="fa-solid fa-house"></i> Home</a>
            <a href="{{ url_for('about') }}"><i class="fa-solid fa-house"></i> About</a>
            <a href="{{ url_for('menu') }}"><i class="fa-solid fa-utensils"></i> Menu</a>
            <a href="{{ url_for('cart') }}"><i class="fa-solid fa-cart-shopping"></i> Cart</a>
            <a href="{{ url_for('order') }}"><i class="fa-solid fa-box"></i> Order</a>
            <a href="{{ url_for('feedback') }}"><i class="fa-solid fa-pen-to-square"></i> Feedback</a>
        </nav>

        <div class="auth-buttons">
            {% if current_user.is_authenticated %}
                <span>Hi, {{ current_user.name }}</span>
                <a href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            {% else %}
                <a href="{{ url_for('login_user_route') }}"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
                <a href="{{ url_for('register') }}"><i class="fa-solid fa-user-plus"></i> Register</a>
            {% endif %}
        </div>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>Â© 2025 CakeHistory. All rights reserved.</p>
    </footer>

    <!-- Floating Chat Button -->
    <div id="chat-btn" class="chat-btn">
    <i class="fa-solid fa-comments"></i>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="chat-modal">
        <div class="chat-modal-content">
            <span class="close-chat">&times;</span>
            <h3><i class="fa-solid fa-message"></i> CakeHistory Assistant</h3>

            <!-- Chat area -->
            <div id="chat-window" class="chat-window">
            <div class="bot-msg">ğŸ‘‹ Hi there! Iâ€™m your CakeHistory assistant.<br>
            Please select a topic to get started:</div>
            </div>

            <!-- Options area -->
            <div id="chat-options" class="chat-options">
            <button class="chat-option" data-topic="general">ğŸ§ General</button>
            <button class="chat-option" data-topic="ordering">ğŸ›ï¸ Ordering & Payment</button>
            <button class="chat-option" data-topic="delivery">ğŸšš Delivery & Pickup</button>
            <button class="chat-option" data-topic="customization">ğŸ‰ Add-ons & Customization</button>
            <button class="chat-option" data-topic="support">â˜ï¸ Support & Issues</button>
            </div>
        </div>
    </div>

    <script>
        const faqs = {
            general: [
                { q: "What types of cakes do you sell?", a: "We offer Pandan Chiffon, Orange Chiffon, Butter Cake, Marble Cake, and Butter Fruit Cake â€” all freshly baked with premium ingredients." },
                { q: "Are your cakes freshly baked daily?", a: "Yes! Every cake is baked fresh on the day of your order to ensure the best texture and flavor." },
                { q: "How long can the cakes be stored after purchase?", a: "Our cakes are best enjoyed fresh on the same day. You may keep them up to 2â€“3 days in an airtight container or refrigerate and reheat lightly before serving." }
            ],
            ordering: [
                { q: "How do I place an order online?", a: "Simply browse our products, add cakes to the cart, and proceed to checkout. Youâ€™ll receive a confirmation email after payment." },
                { q: "Can I schedule my order in advance?", a: "Of course! Choose your preferred delivery or pickup date during checkout." },
                { q: "What payment methods do you accept?", a: "We accept online banking and e-wallets like Touch â€™n Go." }
            ],
            delivery: [
                { q: "Do you provide delivery?", a: "Yes, we deliver across selected areas. Delivery fees depend on your location and appear at checkout." },
                { q: "Can I self-pickup my order?", a: "Yes, self-pickup is available at our bakery â€” select 'Self Pickup' at checkout." },
                { q: "What if I miss my delivery?", a: "Please contact us right away. Weâ€™ll re-arrange delivery or keep your cake for same-day collection." }
            ],
            customization: [
                { q: "Can I add candles or a birthday card?", a: "Yes! We offer number candles, heart-shaped candles, and birthday cards as add-ons." },
                { q: "Can I write a message on the cake or card?", a: "Absolutely â€” just include your message in the 'Special Requests' box during checkout." },
                { q: "Can I request special packaging?", a: "Our standard marble-patterned boxes are already included for all orders." }
            ],
            support: [
                { q: "Who do I contact for order issues?", a: "You can reach our support via WhatsApp or email from the 'Contact Us' section." },
                { q: "What should I do if my cake arrives damaged?", a: "Please take a photo and contact us within 1 hour â€” weâ€™ll review and assist promptly." },
                { q: "Do you offer refunds or replacements?", a: "Yes, if a verified quality or delivery issue occurs, weâ€™ll provide a replacement or refund." }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const isAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}" === "true";

            // Define all restricted links here
            const protectedLinks = [
                { selector: 'a[href="{{ url_for("cart") }}"]', label: 'Cart' },
                { selector: 'a[href="{{ url_for("order") }}"]', label: 'Order' },
                { selector: 'a[href="{{ url_for("feedback") }}"]', label: 'Feedback' }
            ];

            if (!isAuthenticated) {
                protectedLinks.forEach(linkData => {
                    const link = document.querySelector(linkData.selector);
                    if (link) {
                        link.addEventListener('click', e => {
                            e.preventDefault();
                            Swal.fire({
                                icon: 'info',
                                title: 'Login Required',
                                text: `Please login to access your ${linkData.label.toLowerCase()}.`,
                                confirmButtonText: 'Login',
                                confirmButtonColor: '#ff69b4',
                                showCancelButton: true,
                                cancelButtonText: 'Cancel',
                                cancelButtonColor: '#999',
                                scrollbarPadding: false
                            }).then(result => {
                                if (result.isConfirmed) {
                                    window.location.href = "{{ url_for('login_user_route') }}";
                                }
                            });
                        });
                    }
                });
            }

            const chatBtn = document.getElementById('chat-btn');
            const chatModal = document.getElementById('chat-modal');
            const closeChat = document.querySelector('.close-chat');
            const chatWindow = document.getElementById('chat-window');
            const chatOptions = document.getElementById('chat-options');

            // Open & close modal
            chatBtn.addEventListener('click', () => chatModal.style.display = 'flex');
            closeChat.addEventListener('click', () => chatModal.style.display = 'none');
            chatModal.addEventListener('click', e => {
                if (e.target === chatModal) chatModal.style.display = 'none';
            });

            // Helper to add messages
            function addMessage(sender, text) {
                const msg = document.createElement('div');
                msg.classList.add(sender === 'bot' ? 'bot-msg' : 'user-msg');
                msg.innerHTML = text;
                chatWindow.appendChild(msg);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // Show questions for a selected topic
            function showQuestions(topicKey) {
                const questions = faqs[topicKey];
                chatOptions.innerHTML = '';

                addMessage('user', `I want to know about ${topicKey.replace(/^\w/, c => c.toUpperCase())}.`);
                addMessage('bot', "Sure! Here are some things you can ask me about:");

                questions.forEach((item, i) => {
                const btn = document.createElement('button');
                btn.classList.add('chat-option');
                btn.textContent = item.q;
                btn.addEventListener('click', () => showAnswer(topicKey, i));
                chatOptions.appendChild(btn);
                });

                const backBtn = document.createElement('button');
                backBtn.classList.add('back-btn');
                backBtn.textContent = 'â¬… Back to Topics';
                backBtn.addEventListener('click', showMainTopics);
                chatOptions.appendChild(backBtn);
            }

            // Show specific answer
            function showAnswer(topicKey, index) {
                const { q, a } = faqs[topicKey][index];
                addMessage('user', q);

                chatOptions.innerHTML = '';
                addMessage('bot', '<em>typing...</em>');

                setTimeout(() => {
                const typing = chatWindow.querySelector('.bot-msg:last-child');
                if (typing) typing.remove();
                addMessage('bot', a);

                // Show more questions under same category
                showQuestions(topicKey);
                }, 900);
            }

            // Back to main menu
            function showMainTopics() {
                chatOptions.innerHTML = '';
                addMessage('bot', "Alright! You can choose another topic below ğŸ‘‡");
                const topics = {
                general: "ğŸ§ General",
                ordering: "ğŸ›ï¸ Ordering & Payment",
                delivery: "ğŸšš Delivery & Pickup",
                customization: "ğŸ‰ Add-ons & Customization",
                support: "â˜ï¸ Support & Issues"
                };
                Object.entries(topics).forEach(([key, label]) => {
                const btn = document.createElement('button');
                btn.classList.add('chat-option');
                btn.textContent = label;
                btn.addEventListener('click', () => showQuestions(key));
                chatOptions.appendChild(btn);
                });
            }

            // First render (main topics)
            document.querySelectorAll('.chat-option').forEach(btn => {
                btn.addEventListener('click', () => showQuestions(btn.dataset.topic));
            });
        });
    </script>
</body>
</html>
