<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CakeHistory</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="{% if request.endpoint in ['login_user_route', 'register'] %}auth-page{% endif %}">
    <header class="header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CakeHistory Logo" class="logo-img">
            <h1>CakeHistory</h1>
        </div>

        <nav class="nav-links">
            <a href="{{ url_for('home') }}"><i class="fa-solid fa-house"></i> Home</a>
            <a href="{{ url_for('about') }}"><i class="fa-solid fa-house"></i> About</a>
            <a href="{{ url_for('menu') }}"><i class="fa-solid fa-utensils"></i> Menu</a>
            <a href="{{ url_for('cart') }}"><i class="fa-solid fa-cart-shopping"></i> Cart</a>
            <a href="{{ url_for('order') }}"><i class="fa-solid fa-box"></i> Order</a>
            <a href="{{ url_for('feedback') }}"><i class="fa-solid fa-pen-to-square"></i> Feedback</a>
        </nav>

        <div class="auth-buttons">
            {% if current_user.is_authenticated %}
                <span>Hi, {{ current_user.name }}</span>
                <a href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            {% else %}
                <a href="{{ url_for('login_user_route') }}"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
                <a href="{{ url_for('register') }}"><i class="fa-solid fa-user-plus"></i> Register</a>
            {% endif %}
        </div>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>© 2025 CakeHistory. All rights reserved.</p>
    </footer>

    <!-- Floating Chat Button -->
    <div id="chat-btn" class="chat-btn">
    <i class="fa-solid fa-comments"></i>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="chat-modal">
    <div class="chat-modal-content">
        <span class="close-chat">&times;</span>
        <h3><i class="fa-solid fa-message"></i> Chat with CakeHistory</h3>

        <div id="chat-stage">
        <!-- Step 1: Category selection -->
        <div id="chat-topics">
            <p>Select a topic to get started:</p>
            <button class="chat-topic" data-topic="general">🧁 General</button>
            <button class="chat-topic" data-topic="ordering">🛍️ Ordering & Payment</button>
            <button class="chat-topic" data-topic="delivery">🚚 Delivery & Pickup</button>
            <button class="chat-topic" data-topic="customization">🎉 Add-ons & Customization</button>
            <button class="chat-topic" data-topic="support">☎️ Support & Issues</button>
        </div>

        <!-- Step 2: Question selection -->
        <div id="chat-questions" style="display:none;">
            <h4 id="category-title"></h4>
            <div id="question-list"></div>
            <button id="back-to-categories" class="back-btn">⬅ Back</button>
        </div>

        <!-- Step 3: Answer display -->
        <div id="chat-answer" style="display:none;">
            <div id="answer-content"></div>
            <button id="back-to-questions" class="back-btn">⬅ Back to Questions</button>
        </div>
        </div>
    </div>
    </div>

    <script>
        const faqs = {
            general: [
                { q: "What types of cakes do you sell?", a: "We offer Pandan Chiffon, Orange Chiffon, Butter Cake, Marble Cake, and Butter Fruit Cake — all freshly baked with premium ingredients." },
                { q: "Are your cakes freshly baked daily?", a: "Yes! Every cake is baked fresh on the day of your order to ensure the best texture and flavor." },
                { q: "How long can the cakes be stored after purchase?", a: "Our cakes are best enjoyed fresh on the same day. You may keep them up to 2–3 days in an airtight container or refrigerate and reheat lightly before serving." }
            ],
            ordering: [
                { q: "How do I place an order online?", a: "Simply browse our products, add cakes to the cart, and proceed to checkout. You’ll receive a confirmation email after payment." },
                { q: "Can I schedule my order in advance?", a: "Of course! Choose your preferred delivery or pickup date during checkout." },
                { q: "What payment methods do you accept?", a: "We accept online banking and e-wallets like Touch ’n Go." }
            ],
            delivery: [
                { q: "Do you provide delivery?", a: "Yes, we deliver across selected areas. Delivery fees depend on your location and appear at checkout." },
                { q: "Can I self-pickup my order?", a: "Yes, self-pickup is available at our bakery — select 'Self Pickup' at checkout." },
                { q: "What if I miss my delivery?", a: "Please contact us right away. We’ll re-arrange delivery or keep your cake for same-day collection." }
            ],
            customization: [
                { q: "Can I add candles or a birthday card?", a: "Yes! We offer number candles, heart-shaped candles, and birthday cards as add-ons." },
                { q: "Can I write a message on the cake or card?", a: "Absolutely — just include your message in the 'Special Requests' box during checkout." },
                { q: "Can I request special packaging?", a: "Our standard marble-patterned boxes are already included for all orders." }
            ],
            support: [
                { q: "Who do I contact for order issues?", a: "You can reach our support via WhatsApp or email from the 'Contact Us' section." },
                { q: "What should I do if my cake arrives damaged?", a: "Please take a photo and contact us within 1 hour — we’ll review and assist promptly." },
                { q: "Do you offer refunds or replacements?", a: "Yes, if a verified quality or delivery issue occurs, we’ll provide a replacement or refund." }
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            const isAuthenticated = "{{ 'true' if current_user.is_authenticated else 'false' }}" === "true";

            // Define all restricted links here
            const protectedLinks = [
                { selector: 'a[href="{{ url_for("cart") }}"]', label: 'Cart' },
                { selector: 'a[href="{{ url_for("order") }}"]', label: 'Order' },
                { selector: 'a[href="{{ url_for("feedback") }}"]', label: 'Feedback' }
            ];

            if (!isAuthenticated) {
                protectedLinks.forEach(linkData => {
                    const link = document.querySelector(linkData.selector);
                    if (link) {
                        link.addEventListener('click', e => {
                            e.preventDefault();
                            Swal.fire({
                                icon: 'info',
                                title: 'Login Required',
                                text: `Please login to access your ${linkData.label.toLowerCase()}.`,
                                confirmButtonText: 'Login',
                                confirmButtonColor: '#ff69b4',
                                showCancelButton: true,
                                cancelButtonText: 'Cancel',
                                cancelButtonColor: '#999',
                                scrollbarPadding: false
                            }).then(result => {
                                if (result.isConfirmed) {
                                    window.location.href = "{{ url_for('login_user_route') }}";
                                }
                            });
                        });
                    }
                });
            }

            const chatBtn = document.getElementById('chat-btn');
            const chatModal = document.getElementById('chat-modal');
            const closeChat = document.querySelector('.close-chat');

            const topicContainer = document.getElementById('chat-topics');
            const questionContainer = document.getElementById('chat-questions');
            const answerContainer = document.getElementById('chat-answer');

            const categoryTitle = document.getElementById('category-title');
            const questionList = document.getElementById('question-list');
            const answerContent = document.getElementById('answer-content');

            const backToCategories = document.getElementById('back-to-categories');
            const backToQuestions = document.getElementById('back-to-questions');

            // Open & close modal
            chatBtn.addEventListener('click', () => chatModal.style.display = 'flex');
            closeChat.addEventListener('click', () => chatModal.style.display = 'none');
            chatModal.addEventListener('click', e => {
                if (e.target === chatModal) chatModal.style.display = 'none';
            });

            // Handle topic selection
            document.querySelectorAll('.chat-topic').forEach(btn => {
                btn.addEventListener('click', () => {
                const topic = btn.dataset.topic;
                const items = faqs[topic];
                categoryTitle.textContent = btn.textContent;
                questionList.innerHTML = '';

                items.forEach((item, i) => {
                    const qBtn = document.createElement('button');
                    qBtn.classList.add('chat-topic');
                    qBtn.textContent = `Q${i + 1}: ${item.q}`;
                    qBtn.addEventListener('click', () => {
                    answerContent.innerHTML = `
                        <p><strong>Q:</strong> ${item.q}</p>
                        <p><strong>A:</strong> ${item.a}</p>
                    `;
                    questionContainer.style.display = 'none';
                    answerContainer.style.display = 'block';
                    });
                    questionList.appendChild(qBtn);
                });

                topicContainer.style.display = 'none';
                questionContainer.style.display = 'block';
                });
            });

            // Back buttons
            backToCategories.addEventListener('click', () => {
                questionContainer.style.display = 'none';
                topicContainer.style.display = 'block';
            });

            backToQuestions.addEventListener('click', () => {
                answerContainer.style.display = 'none';
                questionContainer.style.display = 'block';
            });
        });
    </script>
</body>
</html>
