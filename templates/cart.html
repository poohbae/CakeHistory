{% extends "base.html" %}
{% block content %}
<div class="cart-page">
    <h2>My Cart</h2>

    {% if current_user.is_authenticated %}
        {% if cake_items or addon_items %}
            <div class="cart-container">
                <!-- Cakes Section -->
                {% if cake_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-cake-candles"></i> Cakes</h3>
                {% for item in cake_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>{{ item.name }}</h3>
                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>
                         {% if item.special_request %}
                            <p class="special-request"><strong>Special Request:</strong> {{ item.special_request }}</p>
                        {% endif %}
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                        <button class="delete-item-btn" data-id="{{ item.id }}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <!-- Add-ons Section -->
                {% if addon_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-gift"></i> Add-ons</h3>
                {% for item in addon_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>
                            {{ item.name }}
                            {% if '(Add-on Slice)' in item.name %}
                                <span class="addon-label"></span>
                            {% endif %}
                        </h3>

                        {% if item.option_selected %}
                            <p><strong>Option: </strong>{{ item.option_selected }}</p>
                        {% endif %}

                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>

                        {% if item.special_request %}
                            <p class="special-request"><strong>Special Request:</strong> {{ item.special_request }}</p>
                        {% endif %}
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                        <button class="delete-item-btn" data-id="{{ item.id }}">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% endif %}


                <!-- Summary -->
                <div class="cart-summary">
                    <p><strong>Subtotal:</strong> RM {{ "%.2f"|format(subtotal|float) }}</p>
                    <p class="grand-total"><strong>Total:</strong> RM 
                        <span id="grand-total">{{ "%.2f"|format(subtotal|float) }}</span>
                    </p>

                    <div class="cart-buttons">
                        <a href="{{ url_for('menu') }}" class="continue-btn">
                            <i class="fa-solid fa-arrow-left"></i> Continue Shopping
                        </a>
                        <button class="place-order-btn">
                            <i class="fa-solid fa-credit-card"></i> Place Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Modal -->
            <div id="orderModal" class="order-modal">
                <div class="order-modal-content">
                    <span class="close-modal">&times;</span>
                    <h3><i class="fa-solid fa-truck"></i> Place Your Order</h3>

                    <form id="orderForm">
                        <label><strong>Choose Method:</strong></label>
                        <label class="method-option">
                            <input type="radio" name="method" value="pickup" checked> Pickup
                        </label>
                        <label class="method-option">
                            <input type="radio" name="method" value="delivery"> Delivery (Grab)
                        </label>
                        <br>

                        <div id="pickup-address" style="display:block;">
                            <p><strong>Pickup Location:</strong> E-gate Commercial Centre, Lebuh Tunku Kudin 1, 11700 Gelugor, Pulau Pinang</p>
                        </div>

                        <div id="delivery-address" style="display:none;">
                            <label><strong>Choose Delivery Area:</strong></label>
                            <select id="delivery-area" name="address">
                                <option value="">-- Select Area --</option>
                                <option value="Bayan Lepas|10">Bayan Lepas (RM10)</option>
                                <option value="Georgetown|8">Georgetown (RM8)</option>
                                <option value="Tanjung Tokong|14">Tanjung Tokong (RM14)</option>
                                <option value="Mainland|22">Mainland (RM22)</option>
                            </select>
                        </div>
                        <br>

                        <label><strong>Date & Time:</strong></label>
                        <input type="datetime-local" name="datetime" required step="300">
                        <br>

                       <!-- Payment Method -->
                        <label><strong>Payment Method:</strong></label>
                        <select id="payment-category" name="payment_category" required>
                            <option value="">-- Select Payment Method --</option>
                            <option value="tng">Touch 'n Go eWallet</option>
                            <option value="online">Online Banking</option>
                        </select>

                        <!-- Online banking options -->
                        <div id="bank-options" style="display:none; margin-top:20px;">
                            <label><strong>Select Bank:</strong></label>
                            <select id="bank_select">
                                {% for method in payment_methods %}
                                    {% set name = (method.name | string | lower) %}
                                    {% if 'bank' in name %}
                                        <option value="{{ method.id }}">{{ method.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Hidden field to store the final method ID (always submitted) -->
                        <input type="hidden" name="payment_method_id" id="payment_method_id">

                        <!-- Store the TnG ID (for JS use only) -->
                        {% for method in payment_methods %}
                            {% if 'touch' in method.name.lower() %}
                                <input type="hidden" id="tng_id" value="{{ method.id }}">
                            {% endif %}
                        {% endfor %}

                        <br><br>
                        <button type="submit" class="confirm-order-btn">Confirm Order</button>
                    </form>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    // Handle remove item button
                    document.querySelectorAll('.delete-item-btn').forEach(btn => {
                        btn.addEventListener('click', e => {
                            e.preventDefault();
                            e.stopPropagation();

                            const itemId = btn.dataset.id;

                            Swal.fire({
                                icon: 'warning',
                                title: 'Remove this item?',
                                text: 'Are you sure you want to delete this from your cart?',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, remove it',
                                cancelButtonText: 'Cancel',
                                confirmButtonColor: '#ff69b4',
                                cancelButtonColor: '#999'
                            }).then(result => {
                                if (result.isConfirmed) {
                                    fetch(`/remove_from_cart/${itemId}`, {
                                        method: 'DELETE',
                                        headers: { 'Content-Type': 'application/json' }
                                    })
                                    .then(res => res.json())
                                    .then(data => {
                                        Swal.fire({
                                            icon: data.success ? 'success' : 'error',
                                            title: data.success ? 'Removed!' : 'Oops...',
                                            text: data.message,
                                            confirmButtonColor: '#ff69b4'
                                        }).then(() => {
                                            if (data.success) {
                                                const itemDiv = btn.closest('.cart-item');
                                                const itemTotal = parseFloat(
                                                    itemDiv.querySelector('.cart-total strong').textContent.replace('RM', '').trim()
                                                );

                                                // Animate remove
                                                itemDiv.style.transition = "opacity 0.3s ease";
                                                itemDiv.style.opacity = "0";

                                                setTimeout(() => {
                                                    itemDiv.remove();

                                                    // âœ… Recalculate subtotal after removal
                                                    const totalEl = document.getElementById('grand-total');
                                                    let currentTotal = parseFloat(totalEl.textContent);
                                                    let newTotal = currentTotal - itemTotal;
                                                    if (newTotal < 0) newTotal = 0;

                                                    // Update total
                                                    totalEl.textContent = newTotal.toFixed(2);
                                                    totalEl.style.transition = "color 0.3s ease";
                                                    totalEl.style.color = "#ff69b4";
                                                    setTimeout(() => totalEl.style.color = "", 500);

                                                    // Update subtotal paragraph correctly
                                                    const subtotalP = document.querySelector('.cart-summary p'); // not the <strong>
                                                    if (subtotalP) {
                                                        subtotalP.innerHTML = `<strong>Subtotal:</strong> RM ${newTotal.toFixed(2)}`;
                                                    }
                                                    
                                                    // If no more items left, replace the entire cart with empty message
                                                    const remainingItems = document.querySelectorAll('.cart-item');
                                                    if (remainingItems.length === 0) {
                                                        const cartContainer = document.querySelector('.cart-container');
                                                        if (cartContainer) {
                                                            // Smooth fade out
                                                            cartContainer.style.transition = "opacity 0.4s ease";
                                                            cartContainer.style.opacity = "0";
                                                            setTimeout(() => {
                                                                cartContainer.remove();

                                                                // Inject empty-cart message dynamically
                                                                const cartPage = document.querySelector('.cart-page');
                                                                cartPage.innerHTML = `
                                                                    <div class="empty-cart">
                                                                        <h3>Your cart is empty!</h3>
                                                                        <p>Looks like you havenâ€™t added any cakes yet.</p>
                                                                        <a href="{{ url_for('menu') }}" class="browse-menu-btn">
                                                                            <i class="fa-solid fa-cake-candles"></i> Browse Menu
                                                                        </a>
                                                                    </div>
                                                                `;
                                                            }, 400);
                                                        }
                                                    }
                                                }, 300);
                                            }
                                        });
                                    });
                                }
                            });
                        });
                    });

                    const modal = document.getElementById("orderModal");
                    const btn = document.querySelector(".place-order-btn");
                    const closeBtn = document.querySelector(".close-modal");
                    const form = document.getElementById("orderForm");
                    const pickup = document.getElementById("pickup-address");
                    const delivery = document.getElementById("delivery-address");
                    const totalEl = document.getElementById("grand-total");
                    const baseTotal = parseFloat(totalEl.textContent);

                    const deliveryArea = document.getElementById("delivery-area");
                    let deliveryFee = 0;

                    // Open & close modal
                    btn.addEventListener("click", () => modal.style.display = "flex");
                    closeBtn.addEventListener("click", () => modal.style.display = "none");
                    modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

                    // Delivery/pickup toggle
                    form.method.forEach(radio => {
                        radio.addEventListener("change", () => {
                            if (radio.value === "delivery" && radio.checked) {
                                pickup.style.display = "none";
                                delivery.style.display = "block";
                                deliveryArea.value = "";
                                totalEl.textContent = baseTotal.toFixed(2);
                            } else if (radio.value === "pickup" && radio.checked) {
                                pickup.style.display = "block";
                                delivery.style.display = "none";
                                totalEl.textContent = baseTotal.toFixed(2);
                                deliveryFee = 0;
                            }
                        });
                    });

                    // When user selects delivery area
                    deliveryArea.addEventListener("change", () => {
                        if (deliveryArea.value) {
                            const [area, fee] = deliveryArea.value.split("|");
                            deliveryFee = parseFloat(fee);
                            totalEl.textContent = (baseTotal + deliveryFee).toFixed(2);
                        } else {
                            totalEl.textContent = baseTotal.toFixed(2);
                            deliveryFee = 0;
                        }
                    });

                    // ðŸ’³ Payment selection logic
                    const paymentCategory = document.getElementById('payment-category');
                    const bankOptions = document.getElementById('bank-options');
                    const bankSelect = document.getElementById('bank_select');
                    const tngId = document.getElementById('tng_id')?.value || '';
                    const paymentIdInput = document.getElementById('payment_method_id');

                    // Update hidden payment_method_id based on selection
                    paymentCategory.addEventListener('change', () => {
                        const category = paymentCategory.value;

                        if (category === 'online') {
                            bankOptions.style.display = 'block';
                            paymentIdInput.value = bankSelect.value;      // use first bank by default
                        } else if (category === 'tng') {
                            bankOptions.style.display = 'none';
                            paymentIdInput.value = tngId;                 // set to Touch â€™n Go ID
                        } else {
                            bankOptions.style.display = 'none';
                            paymentIdInput.value = '';                    // reset
                        }
                    });

                    // Keep hidden field synced when user picks another bank
                    bankSelect.addEventListener('change', () => {
                        if (paymentCategory.value === 'online') {
                            paymentIdInput.value = bankSelect.value;
                        }
                    });


                    // Date & time validation (only 1â€“5 PM, future only, 5-min increments)
                    const dateInput = form.querySelector('input[name="datetime"]');
                    if (dateInput) {
                        const now = new Date();

                        // Round DOWN to nearest 5-minute mark
                        now.setMinutes(Math.floor(now.getMinutes() / 5) * 5);
                        now.setSeconds(0);
                        now.setMilliseconds(0);

                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        dateInput.min = now.toISOString().slice(0, 16);
                        dateInput.step = 300;

                        dateInput.addEventListener("change", () => {
                            const selected = new Date(dateInput.value);
                            const hour = selected.getHours();
                            const minute = selected.getMinutes();

                            // Must be future
                            if (selected <= new Date()) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Invalid Date/Time',
                                    text: 'Please choose a future date and time.',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = '';
                                return;
                            }

                            // Must be within 1â€“5 PM
                            if (hour < 13 || hour >= 17) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Outside Operating Hours',
                                    text: 'Please select a time between 1:00 PM and 5:00 PM.',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = '';
                                return;
                            }

                            // Must be multiple of 5 minutes
                            if (minute % 5 !== 0) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Invalid Time Interval',
                                    text: 'Please select a time in 5-minute increments (e.g. 13:00, 13:05, 13:10, etc.).',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = '';
                                return;
                            }
                        });
                    }

                    // Submit form
                    form.addEventListener("submit", e => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const payload = Object.fromEntries(formData.entries());
                        payload.delivery_fee = deliveryFee;

                        fetch('/place_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            Swal.fire({
                                icon: data.success ? 'success' : 'error',
                                title: data.success ? 'Order Successful!' : 'Oops...',
                                text: data.message,
                                confirmButtonColor: '#ff69b4'
                            }).then(() => {
                                if (data.success) window.location.href = "{{ url_for('order') }}";
                            });
                        });
                    });
                });
            </script>
        {% else %}
            <div class="empty-cart">
                <h3>Your cart is empty!</h3>
                <p>Looks like you havenâ€™t added any cakes yet.</p>
                <a href="{{ url_for('menu') }}" class="browse-menu-btn">
                    <i class="fa-solid fa-cake-candles"></i> Browse Menu
                </a>
            </div>
        {% endif %}
    {% else %}
        <p>Please <a href="{{ url_for('login_user_route') }}">login</a> to view your cart.</p>
    {% endif %}
</div>
{% endblock %}
