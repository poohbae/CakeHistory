{% extends "base.html" %}
{% block content %}
<div class="cart-page">
    <h2>My Cart</h2>

    {% if current_user.is_authenticated %}
        {% if cake_items or addon_items %}
            <div class="cart-container">
                <!-- Cakes Section -->
                {% if cake_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-cake-candles"></i> Cakes</h3>
                {% for item in cake_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>{{ item.name }}</h3>
                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <!-- ðŸŽ Add-ons Section -->
                {% if addon_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-gift"></i> Add-ons</h3>
                {% for item in addon_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>{{ item.name }}</h3>
                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <!-- ðŸ’° Summary -->
                <div class="cart-summary">
                    <p><strong>Subtotal:</strong> RM {{ "%.2f"|format(subtotal) }}</p>
                    <p id="delivery-fee" style="display:none;"><strong>Delivery Fee:</strong> RM 5.00</p>
                    <hr>
                    <p class="grand-total"><strong>Total:</strong> RM 
                        <span id="grand-total">{{ "%.2f"|format(subtotal) }}</span>
                    </p>

                    <div class="cart-buttons">
                        <a href="{{ url_for('menu') }}" class="continue-btn">
                            <i class="fa-solid fa-arrow-left"></i> Continue Shopping
                        </a>
                        <button class="place-order-btn">
                            <i class="fa-solid fa-credit-card"></i> Place Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Modal -->
            <div id="orderModal" class="order-modal">
                <div class="order-modal-content">
                    <span class="close-modal">&times;</span>
                    <h3><i class="fa-solid fa-truck"></i> Place Your Order</h3>

                    <form id="orderForm">
                        <label><strong>Choose Method:</strong></label><br>
                        <label class="method-option">
                            <input type="radio" name="method" value="pickup" checked> Pickup
                        </label>
                        <label class="method-option">
                            <input type="radio" name="method" value="delivery"> Delivery
                        </label>
                        <br>

                        <div id="pickup-address" style="display:block;">
                            <p><strong>Pickup Location:</strong> CakeHistory Shop, Penang, Malaysia</p>
                        </div>

                        <div id="delivery-address" style="display:none;">
                            <input type="text" name="address" placeholder="Enter delivery address">
                        </div>

                        <br>
                        <label><strong>Date & Time:</strong></label><br>
                        <input type="datetime-local" name="datetime" required><br><br>

                        <label><strong>Payment Method:</strong></label><br>
                        <select id="payment-category" name="payment_category" required>
                            <option value="">-- Select Payment Method --</option>
                            <option value="tng">Touch 'n Go eWallet</option>
                            <option value="online">Online Banking</option>
                        </select>

                        <!-- This is the dropdown for banks -->
                        <div id="bank-options" style="display:none; margin-top:10px;">
                            <label><strong>Select Bank:</strong></label><br>
                            <select id="payment_method_id" name="payment_method_id">
                                {% for method in payment_methods %}
                                    {% if 'Bank' in method.name %}
                                        <option value="{{ method.id }}">{{ method.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Store the TnG ID in a hidden input -->
                        {% for method in payment_methods %}
                            {% if 'Touch' in method.name %}
                                <input type="hidden" id="tng_id" value="{{ method.id }}">
                            {% endif %}
                        {% endfor %}

                        <br><br>
                        <button type="submit" class="confirm-order-btn">Confirm Order</button>
                    </form>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const modal = document.getElementById("orderModal");
                    const btn = document.querySelector(".place-order-btn");
                    const closeBtn = document.querySelector(".close-modal");
                    const form = document.getElementById("orderForm");
                    const pickup = document.getElementById("pickup-address");
                    const delivery = document.getElementById("delivery-address");
                    const deliveryFee = document.getElementById("delivery-fee");
                    const totalEl = document.getElementById("grand-total");
                    const baseTotal = parseFloat(totalEl.textContent);

                    const paymentCategory = document.getElementById('payment-category');
                    const bankOptions = document.getElementById('bank-options');
                    const bankSelect = document.getElementById('payment_method_id');
                    const tngId = document.getElementById('tng_id')?.value || '';

                    // ðŸ©· Open & close modal
                    btn.addEventListener("click", () => modal.style.display = "flex");
                    closeBtn.addEventListener("click", () => modal.style.display = "none");
                    modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

                    // ðŸ©· Delivery/pickup toggle
                    form.method.forEach(radio => {
                        radio.addEventListener("change", () => {
                            if (radio.value === "delivery" && radio.checked) {
                                pickup.style.display = "none";
                                delivery.style.display = "block";
                                deliveryFee.style.display = "block";
                                totalEl.textContent = (baseTotal + 5).toFixed(2);
                            } else if (radio.value === "pickup" && radio.checked) {
                                pickup.style.display = "block";
                                delivery.style.display = "none";
                                deliveryFee.style.display = "none";
                                totalEl.textContent = baseTotal.toFixed(2);
                            }
                        });
                    });

                    // ðŸ©· Payment method selection logic
                    paymentCategory.addEventListener('change', () => {
                        const category = paymentCategory.value;

                        if (category === 'online') {
                            bankOptions.style.display = 'block';
                            bankSelect.required = true;
                            bankSelect.value = ''; // ensure user selects a bank
                        } 
                        else if (category === 'tng') {
                            bankOptions.style.display = 'none';
                            bankSelect.required = false;
                            bankSelect.value = tngId; // use hidden TnG ID
                        } 
                        else {
                            bankOptions.style.display = 'none';
                            bankSelect.required = false;
                            bankSelect.value = ''; // reset
                        }
                    });

                    // ðŸ©· Validate datetime (disable past)
                    const dateInput = form.querySelector('input[name="datetime"]');
                    if (dateInput) {
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        dateInput.min = now.toISOString().slice(0, 16);

                        dateInput.addEventListener("change", () => {
                            const selected = new Date(dateInput.value);
                            if (selected <= new Date()) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Invalid Date/Time',
                                    text: 'Please choose a future date and time.',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = dateInput.min;
                            }
                        });
                    }

                    // ðŸ©· Form submit
                    form.addEventListener("submit", e => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const payload = Object.fromEntries(formData.entries());

                        // For TnG, ensure ID is included
                        if (paymentCategory.value === 'tng') {
                            payload.payment_method_id = tngId;
                        }

                        fetch('/place_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            Swal.fire({
                                icon: data.success ? 'success' : 'error',
                                title: data.success ? 'Order Successful!' : 'Oops...',
                                text: data.message,
                                confirmButtonColor: '#ff69b4'
                            }).then(() => {
                                if (data.success) window.location.href = "{{ url_for('order') }}";
                            });
                        });
                    });
                });
            </script>
        {% else %}
            <div class="empty-cart">
                <h3>Your cart is empty!</h3>
                <p>Looks like you havenâ€™t added any cakes yet.</p>
                <a href="{{ url_for('menu') }}" class="browse-menu-btn">
                    <i class="fa-solid fa-cake-candles"></i> Browse Menu
                </a>
            </div>
        {% endif %}
    {% else %}
        <p>Please <a href="{{ url_for('login_user_route') }}">login</a> to view your cart.</p>
    {% endif %}
</div>
{% endblock %}
