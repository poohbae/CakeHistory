{% extends "base.html" %}
{% block content %}
<div class="cart-page">
    <h2>My Cart</h2>

    {% if current_user.is_authenticated %}
        {% if cake_items or addon_items %}
            <div class="cart-container">
                <!-- Cakes Section -->
                {% if cake_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-cake-candles"></i> Cakes</h3>
                {% for item in cake_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>{{ item.name }}</h3>
                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>
                         {% if item.special_request %}
                            <p class="special-request"><strong>Special Request:</strong> {{ item.special_request }}</p>
                        {% endif %}
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <!-- 🎁 Add-ons Section -->
                {% if addon_items %}
                <h3 class="cart-section-title"><i class="fa-solid fa-gift"></i> Add-ons</h3>
                {% for item in addon_items %}
                <div class="cart-item">
                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.name }}">
                    <div class="cart-details">
                        <h3>{{ item.name }}</h3>
                        
                        {% if item.option_selected %}
                            <p class="special-request"><strong>Option: </strong>{{ item.option_selected }}</p>
                        {% endif %}
                        
                        <p>Quantity: {{ item.quantity }}</p>
                        <p>Price per item: RM {{ "%.2f"|format(item.price) }}</p>
                        
                        {% if item.special_request %}
                            <p class="special-request"><strong>Special Request:</strong> {{ item.special_request }}</p>
                        {% endif %}
                    </div>
                    <div class="cart-total">
                        <p>Total: <strong>RM {{ "%.2f"|format(item.total) }}</strong></p>
                    </div>
                </div>
                {% endfor %}
                {% endif %}

                <!-- Summary -->
                <div class="cart-summary">
                    <p><strong>Subtotal:</strong> RM {{ "%.2f"|format(subtotal|float) }}</p>
                    <p class="grand-total"><strong>Total:</strong> RM 
                        <span id="grand-total">{{ "%.2f"|format(subtotal|float) }}</span>
                    </p>

                    <div class="cart-buttons">
                        <a href="{{ url_for('menu') }}" class="continue-btn">
                            <i class="fa-solid fa-arrow-left"></i> Continue Shopping
                        </a>
                        <button class="place-order-btn">
                            <i class="fa-solid fa-credit-card"></i> Place Order
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Modal -->
            <div id="orderModal" class="order-modal">
                <div class="order-modal-content">
                    <span class="close-modal">&times;</span>
                    <h3><i class="fa-solid fa-truck"></i> Place Your Order</h3>

                    <form id="orderForm">
                        <label><strong>Choose Method:</strong></label>
                        <label class="method-option">
                            <input type="radio" name="method" value="pickup" checked> Pickup
                        </label>
                        <label class="method-option">
                            <input type="radio" name="method" value="delivery"> Delivery (Grab)
                        </label>
                        <br>

                        <div id="pickup-address" style="display:block;">
                            <p><strong>Pickup Location:</strong> E-gate Commercial Centre, Lebuh Tunku Kudin 1, 11700 Gelugor, Pulau Pinang</p>
                        </div>

                        <div id="delivery-address" style="display:none;">
                            <label><strong>Choose Delivery Area:</strong></label>
                            <select id="delivery-area" name="address">
                                <option value="">-- Select Area --</option>
                                <option value="Bayan Lepas|10">Bayan Lepas (RM10)</option>
                                <option value="Georgetown|8">Georgetown (RM8)</option>
                                <option value="Tanjung Tokong|14">Tanjung Tokong (RM14)</option>
                                <option value="Mainland|22">Mainland (RM22)</option>
                            </select>
                        </div>
                        <br>

                        <label><strong>Date & Time:</strong></label>
                        <input type="datetime-local" name="datetime" required step="300">
                        <br>

                       <label><strong>Payment Method:</strong></label>
                        <select id="payment-category" name="payment_category" required>
                            <option value="">-- Select Payment Method --</option>
                            <option value="tng">Touch 'n Go eWallet</option>
                            <option value="online">Online Banking</option>
                        </select>

                        <!-- Online banking options -->
                        <div id="bank-options" style="display:none; margin-top:20px;">
                            <label><strong>Select Bank:</strong></label>
                            <select id="payment_method_id" name="payment_method_id">
                                {% for method in payment_methods %}
                                    {% set name = (method.name | string | lower) %}
                                    {% if 'bank' in name %}
                                        <option value="{{ method.id }}">{{ method.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Store the TnG ID in a hidden input -->
                        {% for method in payment_methods %}
                            {% if 'touch' in method.name.lower() %}
                                <input type="hidden" id="tng_id" value="{{ method.id }}">
                            {% endif %}
                        {% endfor %}

                        <br><br>
                        <button type="submit" class="confirm-order-btn">Confirm Order</button>
                    </form>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const modal = document.getElementById("orderModal");
                    const btn = document.querySelector(".place-order-btn");
                    const closeBtn = document.querySelector(".close-modal");
                    const form = document.getElementById("orderForm");
                    const pickup = document.getElementById("pickup-address");
                    const delivery = document.getElementById("delivery-address");
                    const totalEl = document.getElementById("grand-total");
                    const baseTotal = parseFloat(totalEl.textContent);

                    const deliveryArea = document.getElementById("delivery-area");
                    let deliveryFee = 0;

                    // Open & close modal
                    btn.addEventListener("click", () => modal.style.display = "flex");
                    closeBtn.addEventListener("click", () => modal.style.display = "none");
                    modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });

                    // Delivery/pickup toggle
                    form.method.forEach(radio => {
                        radio.addEventListener("change", () => {
                            if (radio.value === "delivery" && radio.checked) {
                                pickup.style.display = "none";
                                delivery.style.display = "block";
                                deliveryArea.value = "";
                                totalEl.textContent = baseTotal.toFixed(2);
                            } else if (radio.value === "pickup" && radio.checked) {
                                pickup.style.display = "block";
                                delivery.style.display = "none";
                                totalEl.textContent = baseTotal.toFixed(2);
                                deliveryFee = 0;
                            }
                        });
                    });

                    // When user selects delivery area
                    deliveryArea.addEventListener("change", () => {
                        if (deliveryArea.value) {
                            const [area, fee] = deliveryArea.value.split("|");
                            deliveryFee = parseFloat(fee);
                            totalEl.textContent = (baseTotal + deliveryFee).toFixed(2);
                        } else {
                            totalEl.textContent = baseTotal.toFixed(2);
                            deliveryFee = 0;
                        }
                    });

                    // Payment selection
                    const paymentCategory = document.getElementById('payment-category');
                    const bankOptions = document.getElementById('bank-options');
                    const bankSelect = document.getElementById('payment_method_id');
                    const tngId = document.getElementById('tng_id')?.value || '';

                    paymentCategory.addEventListener('change', () => {
                        const category = paymentCategory.value;
                        if (category === 'online') {
                            bankOptions.style.display = 'block';
                            bankSelect.required = true;
                            bankSelect.selectedIndex = 0; // default to first bank automatically
                        } else if (category === 'tng') {
                            bankOptions.style.display = 'none';
                            bankSelect.required = false;
                            bankSelect.value = tngId;
                        } else {
                            bankOptions.style.display = 'none';
                            bankSelect.required = false;
                            bankSelect.value = '';
                        }
                    });

                    // Date & time validation (only 1–5 PM, future only)
                    const dateInput = form.querySelector('input[name="datetime"]');
                    if (dateInput) {
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        dateInput.min = now.toISOString().slice(0, 16);
                        dateInput.step = 300;

                        dateInput.addEventListener("change", () => {
                            const selected = new Date(dateInput.value);
                            const hour = selected.getHours();

                            if (selected <= new Date()) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Invalid Date/Time',
                                    text: 'Please choose a future date and time.',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = '';
                                return;
                            }

                            if (hour < 13 || hour >= 17) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Outside Operating Hours',
                                    text: 'Please select a time between 1:00 PM and 5:00 PM.',
                                    confirmButtonColor: '#ff69b4'
                                });
                                dateInput.value = '';
                                return;
                            }
                        });
                    }

                    // Submit form
                    form.addEventListener("submit", e => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const payload = Object.fromEntries(formData.entries());
                        payload.delivery_fee = deliveryFee;

                        fetch('/place_order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            Swal.fire({
                                icon: data.success ? 'success' : 'error',
                                title: data.success ? 'Order Successful!' : 'Oops...',
                                text: data.message,
                                confirmButtonColor: '#ff69b4'
                            }).then(() => {
                                if (data.success) window.location.href = "{{ url_for('order') }}";
                            });
                        });
                    });
                });
            </script>
        {% else %}
            <div class="empty-cart">
                <h3>Your cart is empty!</h3>
                <p>Looks like you haven’t added any cakes yet.</p>
                <a href="{{ url_for('menu') }}" class="browse-menu-btn">
                    <i class="fa-solid fa-cake-candles"></i> Browse Menu
                </a>
            </div>
        {% endif %}
    {% else %}
        <p>Please <a href="{{ url_for('login_user_route') }}">login</a> to view your cart.</p>
    {% endif %}
</div>
{% endblock %}
