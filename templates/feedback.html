{% extends "base.html" %}
{% block content %}
<div class="feedback-auth-wrapper">
    <div class="feedback-container">
        <h2>We Value Your Feedback</h2>
        <p>Share your thoughts about your recent order üç∞</p>

        <form method="POST" action="{{ url_for('feedback') }}">
            <!-- Order selection -->
            <label for="order_id"><strong>Select Order:</strong></label><br><br>
            <select name="order_id" id="order_id" required>
                {% if orders and orders|length > 0 %}
                    {% for order in orders %}
                        <option value="{{ order.id }}">Order #{{ order.id }} ‚Äî {{ order.status }}</option>
                    {% endfor %}
                {% else %}
                    <option value="">No orders available</option>
                {% endif %}
            </select>

           <!-- Rating -->
            <label for="rating"><strong>Rating:</strong></label><br><br>
            <div class="rating-stars">
                {% for star in range(5, 0, -1) %}
                    <input type="radio" name="rating" value="{{ star }}" id="star{{ star }}" required>
                    <label for="star{{ star }}"><i class="fa-solid fa-star"></i></label>
                {% endfor %}
            </div>
            <br>
            <!-- Comment -->
            <textarea name="comments" rows="3" placeholder="Write your feedback here..." required></textarea>

            <button type="submit">Submit Feedback</button>
        </form>
    </div>
</div>

<!-- Previous Feedback Section -->
<div class="previous-feedback-section">
    <h2>üßÅ Your Previous Feedback</h2>

    {% if feedbacks %}
        {% for fb in feedbacks %}
        <div class="feedback-card">
            <h3>Order #{{ fb.order.id }}</h3>
            <p><strong>Order Date:</strong> {{ fb.order.order_date.strftime('%d %b %Y, %I:%M %p') }}</p>
            <p><strong>Status:</strong> {{ fb.order.status }}</p>
            <p><strong>Total Amount:</strong> RM {{ "%.2f"|format(fb.order.total_amount) }}</p>

            {% if fb.order.items %}
            <div class="order-items-list">
                <strong>Items:</strong>
                {% for item in fb.order.items %}
                    <div class="order-item-row">
                        {{ item.product.name }} √ó {{ item.quantity }}
                        ‚Äî RM {{ "%.2f"|format(item.price_each * item.quantity) }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if fb.order.addons %}
            <div class="order-addons-list" style="margin-top:10px;">
                <strong>Add-ons:</strong>
                {% for addon in fb.order.addons %}
                    <div class="order-item-row">
                        {{ addon.addon_name }}
                        {% if addon.option_selected %}
                            ({{ addon.option_selected }})
                        {% endif %}
                        √ó {{ addon.quantity }}
                        ‚Äî RM {{ "%.2f"|format(addon.price_each * addon.quantity) }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="feedback-details">
                <p><strong>Rating:</strong>
                    <span class="rating-stars-display">
                        {% for i in range(fb.rating) %}
                            ‚≠ê
                        {% endfor %}
                    </span>
                </p>
                <p><strong>Comment:</strong> {{ fb.comments }}</p>
                <small>Submitted on {{ fb.created_at.strftime('%d %b %Y, %I:%M %p') }}</small>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="no-feedback">You haven‚Äôt submitted any feedback yet. ü•∫</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form[action="{{ url_for("feedback") }}"]');
        if (!form) return;

        form.addEventListener('submit', e => {
            e.preventDefault();

            const formData = new FormData(form);

            fetch('{{ url_for("feedback") }}', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                Swal.fire({
                    icon: data.success ? 'success' : 'error',
                    title: data.success ? 'Feedback Submitted!' : 'Oops...',
                    text: data.message,
                    confirmButtonColor: '#ff69b4'
                }).then(() => {
                    if (data.success) {
                        // Optional: reload to show updated feedback list
                        window.location.reload();
                    }
                });
            })
            .catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Something went wrong. Please try again.',
                    confirmButtonColor: '#ff69b4'
                });
                console.error(err);
            });
        });
    });
</script>
{% endblock %}
