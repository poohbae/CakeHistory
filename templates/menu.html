{% extends "base.html" %}
{% block content %}
<!-- Delivery / Pickup Note -->
<div class="delivery-note">
    <p><strong>Note:</strong></p>
    <p>‚Ä¢ Self-pickup available at <b>E-Gate, Penang</b> with no additional charge.</p>
    <p>‚Ä¢ Delivery fees may vary depending on Grab‚Äôs realtime rate.</p>
    <p>‚Ä¢ Best enjoyed within 3 days from purchase for freshness and flavor.</p>
</div>

<!-- BUTTER CAKE SERIES -->
<section class="menu-section">
    <h2>üßà Butter Cake Series</h2>
    <div class="menu-grid">
        {% for cake in cakes %}
            {% if "Chiffon" not in cake.name and "Premium" not in cake.name %}
            <div class="menu-item" 
                data-item-type="product"
                data-id="{{ cake.id }}" 
                data-name="{{ cake.name }}" 
                data-description="{{ cake.description }}" 
                data-img="{{ url_for('static', filename='images/' + cake.img) }}"
                data-img2="{{ url_for('static', filename='images/' + cake.img2) }}">
                
                <!-- Display smaller image (img2) -->
                <img src="{{ url_for('static', filename='images/' + cake.img2) }}" alt="{{ cake.name }}">
                <h3>{{ cake.name }}</h3>
                <p>RM {{ "%.2f"|format(cake.price) }}</p>

                <div class="menu-actions">
                    <div class="quantity">
                        <button class="qty-btn minus">‚àí</button>
                        <span class="qty-value">1</span>
                        <button class="qty-btn plus">+</button>
                    </div>
                    {% if current_user.is_authenticated %}
                        <button class="add-cart-btn">Add to Cart</button>
                    {% else %}
                        <button class="add-cart-btn login-prompt">Add to Cart</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</section>

<hr>

<!-- CHIFFON CAKE SERIES -->
<section class="menu-section">
    <h2>‚òÅÔ∏è Chiffon Cake Series</h2>
    <div class="menu-grid">
        {% for cake in cakes %}
            {% if "Chiffon" in cake.name %}
            <div class="menu-item" 
                data-id="{{ cake.id }}"
                data-item-type="product" 
                data-name="{{ cake.name }}" 
                data-description="{{ cake.description }}" 
                data-img="{{ url_for('static', filename='images/' + cake.img) }}"
                data-img2="{{ url_for('static', filename='images/' + cake.img2) }}">
                
                <!-- Display smaller image (img2) -->
                <img src="{{ url_for('static', filename='images/' + cake.img2) }}" alt="{{ cake.name }}">
                <h3>{{ cake.name }}</h3>
                <p>RM {{ "%.2f"|format(cake.price) }}</p>

                <div class="menu-actions">
                    <div class="quantity">
                        <button class="qty-btn minus">‚àí</button>
                        <span class="qty-value">1</span>
                        <button class="qty-btn plus">+</button>
                    </div>
                    {% if current_user.is_authenticated %}
                        <button class="add-cart-btn">Add to Cart</button>
                    {% else %}
                        <button class="add-cart-btn login-prompt">Add to Cart</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</section>

<hr>

<!-- PREMIUM SECTION -->
<section class="menu-section">
    <h2>üíé Premium Series</h2>
    <div class="menu-grid">
        {% for cake in cakes %}
            {% if "Premium" in cake.name %}
            <div class="menu-item" 
                data-id="{{ cake.id }}"
                data-item-type="product"
                data-name="{{ cake.name }}" 
                data-description="{{ cake.description }}" 
                data-img="{{ url_for('static', filename='images/' + cake.img) }}"
                data-img2="{{ url_for('static', filename='images/' + cake.img2) }}">
                
                <!-- Display smaller image (img2) -->
                <img src="{{ url_for('static', filename='images/' + cake.img2) }}" alt="{{ cake.name }}">
                <h3>{{ cake.name }}</h3>
                <p>RM {{ "%.2f"|format(cake.price) }}</p>

                <div class="menu-actions">
                    <div class="quantity">
                        <button class="qty-btn minus">‚àí</button>
                        <span class="qty-value">1</span>
                        <button class="qty-btn plus">+</button>
                    </div>
                    {% if current_user.is_authenticated %}
                        <button class="add-cart-btn">Add to Cart</button>
                    {% else %}
                        <button class="add-cart-btn login-prompt">Add to Cart</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</section>

<hr>

<!-- ADD-ONS SECTION -->
<section class="menu-section">
    <h2>üéÅ Add-ons</h2>
    <p>Customize your order with add-on slices, candles, cards, and boxes</p>

    <div class="menu-grid">
        <!-- üåü Slices -->
        {% for cake in cakes %}
        {% if cake.img3 %}
        <div class="menu-item"
            data-item-type="product"
            data-id="{{ cake.id }}" 
            data-name="{{ cake.name }}" 
            data-description="{{ cake.description }}" 
            data-img="{{ url_for('static', filename='images/' + cake.img3) }}"
            data-img3="{{ url_for('static', filename='images/' + cake.img3) }}">
            
            <img src="{{ url_for('static', filename='images/' + cake.img3) }}" alt="{{ cake.name }}">
            <h3>{{ cake.name }}</h3>
            <p>RM {{ "%.2f"|format(cake.price) }}</p>

            <div class="menu-actions">
                <div class="quantity">
                    <button class="qty-btn minus">‚àí</button>
                    <span class="qty-value">1</span>
                    <button class="qty-btn plus">+</button>
                </div>
                {% if current_user.is_authenticated %}
                    <button class="add-cart-btn">Add to Cart</button>
                {% else %}
                    <button class="add-cart-btn login-prompt">Add to Cart</button>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- Candles -->
        {% for candle in candles %}
        <div class="menu-item"
            data-item-type="candle"
            data-id="{{ candle.id }}" 
            data-name="{{ candle.name }}" 
            data-description="{{ candle.description }}" 
            data-img="{{ url_for('static', filename='images/' + candle.img) }}"
            data-type="{{ candle.type }}">
            
            <img src="{{ url_for('static', filename='images/' + candle.img) }}" alt="{{ candle.name }}">
            <h3>{{ candle.name }}</h3>
            <p>RM {{ "%.2f"|format(candle.price) }}</p>

            <div class="option-section">
                {% if candle.type == 'number' %}
                <label for="number-num-{{ candle.id }}">Choose Number:</label>
                <select id="number-num-{{ candle.id }}" class="addon-select">
                    {% for n in range(1, 13) %}
                        <option value="Number {{ n }}">{{ n }}</option>
                    {% endfor %}
                </select>
                {% elif candle.type == 'love' %}
                <label for="love-color-{{ candle.id }}">Choose Color:</label>
                <select id="love-color-{{ candle.id }}" class="addon-select">
                    <option value="Red">Red</option>
                    <option value="Pink">Pink</option>
                    <option value="Blue">Blue</option>
                    <option value="Green">Green</option>
                </select>
                {% endif %}
            </div>
            <div class="menu-actions">
                <div class="quantity">
                    <button class="qty-btn minus">‚àí</button>
                    <span class="qty-value">1</span>
                    <button class="qty-btn plus">+</button>
                </div>
                {% if current_user.is_authenticated %}
                    <button class="add-cart-btn">Add to Cart</button>
                {% else %}
                    <button class="add-cart-btn login-prompt">Add to Cart</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Cards -->
        {% for card in cards %}
        <div class="menu-item" 
            data-item-type="card"
            data-id="{{ card.id }}" 
            data-name="{{ card.name }}" 
            data-description="{{ card.description }}" 
            data-img="{{ url_for('static', filename='images/' + card.img) }}">
            
            <img src="{{ url_for('static', filename='images/' + card.img) }}" alt="{{ card.name }}">
            <h3>{{ card.name }}</h3>
            <p>RM {{ "%.2f"|format(card.price) }}</p>
            <div class="option-section">
                <label for="card-design-{{ card.id }}">Choose Design:</label>
                <select id="card-design-{{ card.id }}" class="addon-select">
                    <option value="Birthday">Birthday</option>
                    <option value="Appreciation">Appreciation</option>
                    <option value="Get Well Soon">Get Well Soon</option>
                    <option value="Congratulations">Congratulations</option>
                </select>
            </div>
            <div class="menu-actions">
                <div class="quantity">
                    <button class="qty-btn minus">‚àí</button>
                    <span class="qty-value">1</span>
                    <button class="qty-btn plus">+</button>
                </div>
                {% if current_user.is_authenticated %}
                    <button class="add-cart-btn">Add to Cart</button>
                {% else %}
                    <button class="add-cart-btn login-prompt">Add to Cart</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Boxes -->
        {% for box in boxes %}
        <div class="menu-item" 
            data-item-type="box"
            data-id="{{ box.id }}" 
            data-name="{{ box.name }}" 
            data-description="{{ box.description }}" 
            data-img="{{ url_for('static', filename='images/' + box.img) }}">
            
            <img src="{{ url_for('static', filename='images/' + box.img) }}" alt="{{ box.name }}">
            <h3>{{ box.name }}</h3>
            <p>RM {{ "%.2f"|format(box.price) }}</p>
            <div class="menu-actions">
                <div class="quantity">
                    <button class="qty-btn minus">‚àí</button>
                    <span class="qty-value">1</span>
                    <button class="qty-btn plus">+</button>
                </div>
                {% if current_user.is_authenticated %}
                    <button class="add-cart-btn">Add to Cart</button>
                {% else %}
                    <button class="add-cart-btn login-prompt">Add to Cart</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Modal for cake details -->
<div id="cakeModal" class="cake-modal">
    <div class="cake-modal-content">
        <img id="modal-img" src="" alt="Cake Image">
        <h3 id="modal-title"></h3>
        <p id="modal-desc"></p>
    </div>
</div>

<script>
    // Modal interaction (trigger only on image hover)
    const modal = document.getElementById('cakeModal');
    const modalImg = document.getElementById('modal-img');
    const modalTitle = document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-desc');

    let hoverTimer;

    // Loop through all menu images
    document.querySelectorAll('.menu-item img').forEach(img => {
        const item = img.closest('.menu-item');

        img.addEventListener('mouseenter', () => {
            hoverTimer = setTimeout(() => {
                modal.classList.add('show');

                // If the item has img3 (Special Edition) ‚Üí use it
                if (item.dataset.img3) {
                    modalImg.src = item.dataset.img3;
                } 
                // Otherwise use the regular img (for butter/chiffon/premium)
                else {
                    modalImg.src = item.dataset.img;
                }

                modalTitle.textContent = item.dataset.name;
                modalDesc.textContent = item.dataset.description || "No description available.";
            }, 150);
        });

        img.addEventListener('mouseleave', () => {
            clearTimeout(hoverTimer);
            modal.classList.remove('show');
        });
    });

    // Quantity control
    document.querySelectorAll('.menu-item').forEach(item => {
        const minus = item.querySelector('.minus');
        const plus = item.querySelector('.plus');
        const value = item.querySelector('.qty-value');

        if (!minus || !plus || !value) return;

        let qty = 1;
        const MAX_QTY = 20;

        minus.addEventListener('click', e => {
            e.stopPropagation();
            if (qty > 1) qty--;
            value.textContent = qty;
        });

        plus.addEventListener('click', e => {
            e.stopPropagation();
            if (qty < MAX_QTY) {
                qty++;
                value.textContent = qty;
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Limit Reached',
                    text: 'Maximum quantity is 20 per item.',
                    confirmButtonColor: '#ff69b4',
                    scrollbarPadding: false
                });
            }
        });
    });

    // Login prompt SweetAlert
    document.querySelectorAll('.login-prompt').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();    
            Swal.fire({
                icon: 'info',
                title: 'Login Required',
                text: 'Please login to add items to your cart',
                confirmButtonText: 'Login',
                confirmButtonColor: '#ff69b4',
                showCancelButton: true,
                cancelButtonText: 'Cancel',
                cancelButtonColor: '#999',
                scrollbarPadding: false
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{{ url_for('login_user_route') }}";
                }
            });

        });
    });

    // Add to cart
    document.querySelectorAll('.add-cart-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            const item = e.target.closest('.menu-item');
            const productId = item.dataset.id;
            const qty = parseInt(item.querySelector('.qty-value').textContent);
            const option = item.querySelector('.addon-select')?.value || null;

            // Ask for special request note before adding to cart
            Swal.fire({
                title: 'Any Special Request?',
                input: 'text',
                inputLabel: 'E.g. add normal candle, birthday message, or short note.',
                inputPlaceholder: 'Leave blank if none',
                showCancelButton: true,
                confirmButtonText: 'Add to Cart',
                confirmButtonColor: '#ff69b4',
                cancelButtonText: 'Cancel',
                cancelButtonColor: '#999',
                scrollbarPadding: false,
                customClass: {
                    popup: 'swal-custom-popup',   // target popup
                    input: 'swal-custom-input'    // target input
                },
                didOpen: () => {
                    const input = Swal.getInput();
                    if (input) {
                        input.style.textAlign = 'center';
                        input.style.fontSize = '15px';
                        input.style.padding = '10px';
                    }
                }
            }).then(result => {
                if (result.isConfirmed) {
                    const specialRequest = result.value || null;
                    const type = item.dataset.itemType || 'product';

                    fetch('/add_to_cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: qty,
                        option_selected: option,
                        special_request: specialRequest,
                        item_type: type
                    })
                    })
                    .then(res => res.json())
                    .then(data => {
                        Swal.fire({
                            icon: data.success ? 'success' : 'error',
                            title: data.success ? 'Added to Cart!' : 'Oops...',
                            text: data.message,
                            confirmButtonColor: '#ff69b4',
                            scrollbarPadding: false
                        });
                    });
                }
            });
        });
    });
</script>
{% endblock %}