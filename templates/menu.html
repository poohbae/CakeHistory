{% extends "base.html" %}
{% block content %}
<div class="menu-grid">
    {% for cake in cakes %}
    <div class="menu-item" data-id="{{ cake.id }}" data-name="{{ cake.name }}" data-description="{{ cake.description }}" data-img="{{ url_for('static', filename='images/' + cake.img) }}">
        <img src="{{ url_for('static', filename='images/' + cake.img) }}" alt="{{ cake.name }}">
        <h3>{{ cake.name }}</h3>
        <p>RM {{ "%.2f"|format(cake.price) }}</p>

        <!-- Menu actions (not affected by hover) -->
        <div class="menu-actions">
            <div class="quantity">
                <button class="qty-btn minus">âˆ’</button>
                <span class="qty-value">1</span>
                <button class="qty-btn plus">+</button>
            </div>

            {% if current_user.is_authenticated %}
                <button class="add-cart-btn">Add to Cart</button>
            {% else %}
                <button class="add-cart-btn login-prompt">Add to Cart</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal for cake details -->
<div id="cakeModal" class="cake-modal">
    <div class="cake-modal-content">
        <span class="close-modal">&times;</span>
        <img id="modal-img" src="" alt="Cake Image">
        <h3 id="modal-title"></h3>
        <p id="modal-desc"></p>
    </div>
</div>

<script>
    // Quantity control
    document.querySelectorAll('.menu-item').forEach(item => {
        const minus = item.querySelector('.minus');
        const plus = item.querySelector('.plus');
        const value = item.querySelector('.qty-value');
        let qty = 1;
        const MAX_QTY = 20;

        minus.addEventListener('click', e => {
            e.stopPropagation(); // prevent modal trigger
            if (qty > 1) qty--;
            value.textContent = qty;
        });

        plus.addEventListener('click', e => {
            e.stopPropagation();
            if (qty < MAX_QTY) {
                qty++;
                value.textContent = qty;
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Limit Reached',
                    text: 'Maximum quantity is 20 per item.',
                    confirmButtonColor: '#ff69b4',
                    scrollbarPadding: false
                });
            }
        });
    });


    // Login prompt SweetAlert
    document.querySelectorAll('.login-prompt').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            Swal.fire({
                icon: 'info',
                title: 'Login Required',
                text: 'Please login to add items to your cart',
                confirmButtonColor: '#ff69b4',
                confirmButtonText: 'Login',
                scrollbarPadding: false
            }).then(() => {
                window.location.href = "{{ url_for('login_user_route') }}";
            });
        });
    });

    //  Modal interaction
    const modal = document.getElementById('cakeModal');
    const modalImg = document.getElementById('modal-img');
    const modalTitle = document.getElementById('modal-title');
    const modalDesc = document.getElementById('modal-desc');
    const closeModal = document.querySelector('.close-modal');

    let hoverTimer;

    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
            hoverTimer = setTimeout(() => {
                modal.style.display = 'flex';
                modalImg.src = item.dataset.img;
                modalTitle.textContent = item.dataset.name;
                modalDesc.textContent = item.dataset.description;
            }, 300); // wait 300ms before showing
        });

        item.addEventListener('mouseleave', () => {
            clearTimeout(hoverTimer);
            modal.style.display = 'none';
        });
    });

    closeModal.addEventListener('click', () => modal.style.display = 'none');
    modal.addEventListener('click', e => {
        if (e.target === modal) modal.style.display = 'none';
    });

    // Add to cart
    document.querySelectorAll('.add-cart-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();

            const item = e.target.closest('.menu-item');
            const productName = item.dataset.name;
            const productId = item.dataset.id || item.getAttribute('data-id');
            const qty = parseInt(item.querySelector('.qty-value').textContent);

            fetch('/add_to_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId, quantity: qty })
            })
            .then(res => res.json())
            .then(data => {
                Swal.fire({
                    icon: data.success ? 'success' : 'error',
                    title: data.success ? 'Added to Cart!' : 'Oops...',
                    text: data.message,
                    confirmButtonColor: '#ff69b4',
                    scrollbarPadding: false
                });
            });
        });
    });
</script>
{% endblock %}